using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using QUANLYCOFFEESHOP.DTO;

namespace QUANLYCOFFEESHOP.DAL
{
    public class NhanVienDAL
    {
        public List<NhanVienDTO> GetAll()
        {
            List<NhanVienDTO> list = new List<NhanVienDTO>();

            string query = "SELECT * FROM NhanVien";
            DataTable dt = DatabaseHelper.ExecuteQuery(query);

            foreach (DataRow row in dt.Rows)
            {
                NhanVienDTO nv = new NhanVienDTO
                {
                    MaNV = row["MaNV"].ToString(),
                    HoTen = row["HoTen"].ToString(),
                    GioiTinh = row["GioiTinh"].ToString(),
                    NgaySinh = Convert.ToDateTime(row["NgaySinh"]),
                    SDT = row["SDT"].ToString(),
                    DiaChi = row["DiaChi"].ToString(),
                    NgayVaoLam = Convert.ToDateTime(row["NgayVaoLam"])
                };
                list.Add(nv);
            }

            return list;
        }

        public NhanVienDTO GetByID(string maNV)
        {
            string query = "SELECT * FROM NhanVien WHERE MaNV = @MaNV";
            SqlParameter[] parameters = {
                new SqlParameter("@MaNV", maNV)
            };

            DataTable dt = DatabaseHelper.ExecuteQuery(query, parameters);

            if (dt.Rows.Count > 0)
            {
                DataRow row = dt.Rows[0];
                return new NhanVienDTO
                {
                    MaNV = row["MaNV"].ToString(),
                    HoTen = row["HoTen"].ToString(),
                    GioiTinh = row["GioiTinh"].ToString(),
                    NgaySinh = Convert.ToDateTime(row["NgaySinh"]),
                    SDT = row["SDT"].ToString(),
                    DiaChi = row["DiaChi"].ToString(),
                    NgayVaoLam = Convert.ToDateTime(row["NgayVaoLam"])
                };
            }

            return null;
        }

        public bool Insert(NhanVienDTO nhanVien)
        {
            try
            {
                string query = "INSERT INTO NhanVien (MaNV, HoTen, GioiTinh, NgaySinh, SDT, DiaChi, NgayVaoLam) " +
                              "VALUES (@MaNV, @HoTen, @GioiTinh, @NgaySinh, @SDT, @DiaChi, @NgayVaoLam)";

                SqlParameter[] parameters = {
                    new SqlParameter("@MaNV", nhanVien.MaNV),
                    new SqlParameter("@HoTen", nhanVien.HoTen),
                    new SqlParameter("@GioiTinh", nhanVien.GioiTinh),
                    new SqlParameter("@NgaySinh", nhanVien.NgaySinh),
                    new SqlParameter("@SDT", nhanVien.SDT),
                    new SqlParameter("@DiaChi", nhanVien.DiaChi),
                    new SqlParameter("@NgayVaoLam", nhanVien.NgayVaoLam)
                };

                int result = DatabaseHelper.ExecuteNonQuery(query, parameters);
                return result > 0;
            }
            catch
            {
                return false;
            }
        }

        public bool Update(NhanVienDTO nhanVien)
        {
            try
            {
                string query = "UPDATE NhanVien SET HoTen = @HoTen, GioiTinh = @GioiTinh, NgaySinh = @NgaySinh, " +
                              "SDT = @SDT, DiaChi = @DiaChi, NgayVaoLam = @NgayVaoLam WHERE MaNV = @MaNV";

                SqlParameter[] parameters = {
                    new SqlParameter("@MaNV", nhanVien.MaNV),
                    new SqlParameter("@HoTen", nhanVien.HoTen),
                    new SqlParameter("@GioiTinh", nhanVien.GioiTinh),
                    new SqlParameter("@NgaySinh", nhanVien.NgaySinh),
                    new SqlParameter("@SDT", nhanVien.SDT),
                    new SqlParameter("@DiaChi", nhanVien.DiaChi),
                    new SqlParameter("@NgayVaoLam", nhanVien.NgayVaoLam)
                };

                int result = DatabaseHelper.ExecuteNonQuery(query, parameters);
                return result > 0;
            }
            catch
            {
                return false;
            }
        }

        public bool Delete(string maNV)
        {
            try
            {
                string query = "DELETE FROM NhanVien WHERE MaNV = @MaNV";
                SqlParameter[] parameters = {
                    new SqlParameter("@MaNV", maNV)
                };

                int result = DatabaseHelper.ExecuteNonQuery(query, parameters);
                return result > 0;
            }
            catch
            {
                return false;
            }
        }

        public List<NhanVienDTO> Search(string keyword)
        {
            List<NhanVienDTO> list = new List<NhanVienDTO>();

            string query = "SELECT * FROM NhanVien WHERE HoTen LIKE @Keyword OR MaNV LIKE @Keyword OR SDT LIKE @Keyword";
            SqlParameter[] parameters = {
                new SqlParameter("@Keyword", "%" + keyword + "%")
            };

            DataTable dt = DatabaseHelper.ExecuteQuery(query, parameters);

            foreach (DataRow row in dt.Rows)
            {
                NhanVienDTO nv = new NhanVienDTO
                {
                    MaNV = row["MaNV"].ToString(),
                    HoTen = row["HoTen"].ToString(),
                    GioiTinh = row["GioiTinh"].ToString(),
                    NgaySinh = Convert.ToDateTime(row["NgaySinh"]),
                    SDT = row["SDT"].ToString(),
                    DiaChi = row["DiaChi"].ToString(),
                    NgayVaoLam = Convert.ToDateTime(row["NgayVaoLam"])
                };
                list.Add(nv);
            }

            return list;
        }
    }
}
